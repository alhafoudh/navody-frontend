{% extends "podanie.njk" %}

{% from "button/macro.njk" import govukButton %}

{% block header %}
    {{ govukHeader({
        productName: 'podatelna.slovensko.digital',
        homepageUrl: '/examples/podanie'
    }) }}
{% endblock %}

{% block main %}
    <style>
        .btn-start-podpisuj {
            display: none;
        }
    </style>

    <p>
      Ste prihlásený/á ako: <strong id="user-placeholder">TODO</strong>
      <br>
      <a href="#" class="govuk-link--muted">Odhlásiť</a>
    </p>

    <h1>
      Podpisovanie
    </h1>

    {{ govukButton({
        "text": "Podpísať",
        "classes": "login"
    }) }}

    <a href="https://test-portal.podpisuj.sk/staticweb/test-podpisuj.jnlp" class="btn-start-podpisuj">Spustiť podpisuj.sk</a>
{% endblock %}

{% block js %}
    <script>
      function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      };

      var b64toBlob = function(b64Data, contentType='', sliceSize=512) {
        var byteCharacters = atob(b64Data);
        var byteArrays = [];

        for (var offset = 0; offset < byteCharacters.length; offset += sliceSize) {
          var slice = byteCharacters.slice(offset, offset + sliceSize);

          var byteNumbers = new Array(slice.length);
          for (var i = 0; i < slice.length; i++) {
            byteNumbers[i] = slice.charCodeAt(i);
          }

          var byteArray = new Uint8Array(byteNumbers);
          byteArrays.push(byteArray);
        }

        var blob = new Blob(byteArrays, {type: contentType});
        return blob;
      }

        var podanieFormDataRaw = localStorage.getItem('podanie-form-data');

        if (podanieFormDataRaw)
        {
          podanieFormData = JSON.parse(podanieFormDataRaw)
        }
        else
        {
          podanieFormData = {
            subject: 'Test',
            message: 'Test message',
            file: null
          }
        }

        var base64File = '';

        $(document).ready(function(){
          var oboToken = new URL(window.location.href).searchParams.get("token")
          $('#user-placeholder').html(parseJwt(oboToken).name)

          $('body').on('click', '.login', function() {
            console.log('login');

            $.post('http://127.0.0.1:14741/login', {
              username: 'pouzivatel.prvy@slovensko.digital',
              authorizationCode: 'ac53453004432',
              partnerId: 112423
            })
              .done(function(response) {
                console.log(response);

                var data = new FormData();

                var form = b64toBlob(podanieFormData.xml.data, podanieFormData.xml.mimeType)

                data.append('file-1', form, podanieFormData.xml.name);

                if (podanieFormData.file)
                {
                  var file2 = b64toBlob(podanieFormData.file.data, podanieFormData.file.mimetype);
                  data.append('file-2', file2, podanieFormData.file.name);
                }

                jQuery.ajax({
                  url: 'http://127.0.0.1:14741/sign',
                  data: data,
                  cache: false,
                  contentType: false,
                  processData: false,
                  method: 'POST',
                  type: 'POST', // For jQuery < 1.9
                  success: function(response){
                    console.log(response);
                    const {files} = response
                    localStorage.setItem('podanie-signed-data', JSON.stringify({ files }))
                    window.location = `/examples/podanie/odoslanie?token=${oboToken}`
                  }
                });
            })
              .fail(function(response, textStatus, errorThrown) {
                $('.btn-start-podpisuj').show();
                console.log('error', response, textStatus, errorThrown);
              });
          });
        });
    </script>
{% endblock %}
