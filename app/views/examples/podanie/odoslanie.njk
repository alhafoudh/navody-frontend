{% extends "podanie.njk" %}
{% block main %}
    <p>
      Ste prihlásený ako: <strong id="user-placeholder">TODO</strong>
      <br>
      <a href="#" class="govuk-link--muted">Odhlásiť</a>
    </p>

    <h1>
      Odoslanie
    </h1>

    <form>
      <input id="obo_token" type="hidden" name="obo_token">
      <button class="govuk-button">Odoslať</button>
    </form>
    <p id="flash-success" style="color: green"></p>
    <p id="flash-error" style="color: red"></p>
{% endblock %}

{% block js %}
    <script>
      function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      };

      $(document).ready(function(){
        var oboToken = new URL(window.location.href).searchParams.get("token")

        $('#user-placeholder').html(parseJwt(oboToken).name)

        $('form').on('submit', function(event){
          $('form > button').prop('disabled', true).html('Odosielam...')

          $.ajax({
            type: 'post',
            data: {
              oboToken
            },
            success: function(data) {
              $('#flash-success').html(`Vaša správa bola úspešne odoslaná!`)
            },
            error: function(data) {
              $('#flash-error').html(`Pri odosielaní sa vyskytol problém: ${data.responseJSON.message}`)
            },
            complete: function(data) {
              $('form > button').attr('disabled', false).html('Odoslať')
            }
          });

          return false;
        });
      });
    </script>
{% endblock %}
