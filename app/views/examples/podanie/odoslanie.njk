{% extends "podanie.njk" %}
{% block main %}
    <p>
      Ste prihlásený ako: <strong id="user-placeholder">TODO</strong>
      <br>
      <a href="#" class="govuk-link--muted">Odhlásiť</a>
    </p>

    <h1>
      Odoslanie
    </h1>

    <strong>Predmet</strong><br>
    <p id="message-subject-placeholder"></p>

    <strong>Správa</strong><br>
    <p id="message-body-placeholder"></p>

    <strong>Prílohy</strong><br>
    <p id="message-file-placeholder"></p>

    <form>
      <input id="obo_token" type="hidden" name="obo_token">
      <button class="govuk-button">Odoslať</button>
    </form>
    <p id="flash-success" style="color: green"></p>
    <p id="flash-error" style="color: red"></p>
{% endblock %}

{% block js %}
    <script>
      function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      };

      $(document).ready(function(){
        var oboToken = new URL(window.location.href).searchParams.get("token")
        var { message, subject, file } = JSON.parse(localStorage.getItem('podanie-form-data'))

        $('#user-placeholder').html(parseJwt(oboToken).name)
        $('#message-subject-placeholder').html(subject)
        $('#message-body-placeholder').html(message)
        $('#message-file-placeholder').html(`${file.name} (${file.mimeType})`)


        $('form').on('submit', function(event){
          $('form > button').prop('disabled', true).html('Odosielam...')

          $.ajax({
            type: 'post',
            data: {
              oboToken,
              message: {
                subject: subject,
                text: message,
              }
            },
            success: function(data) {
              $('#flash-success').html(`Vaša správa bola úspešne odoslaná!`)
            },
            error: function(data) {
              $('#flash-error').html(`Pri odosielaní sa vyskytol problém: ${data.responseJSON.message}`)
            },
            complete: function(data) {
              $('form > button').attr('disabled', false).html('Odoslať')
            }
          });

          return false;
        });
      });
    </script>
{% endblock %}
