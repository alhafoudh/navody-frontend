<!DOCTYPE html>
<html lang="en">
<head>
<title>Podpisuj.sk API test page</title>
</head>
<body>
<b>Podpisuj.sk API test page</b>
<br><br>

<button type="button" id="button_app_status">App status</button><br>
<hr>

<textarea id="username" rows="1" cols="25">signature-api@acme.com</textarea><br>
<textarea id="partner_id" rows="1" cols="25">999999</textarea><br>
<textarea id="private_key_pem" rows="30" cols="80">Put your private key (in PEM format) here</textarea><br>
<button type="button" id="button_login">Login</button><br>
<hr>

<button type="button" id="button_logout">Logout</button><br>
<hr>

<input id="file_input" type="file"><br>
<button type="button" id="button_sign">Sign</button><br>
<hr>

<script>
function base64StringToArrayBuffer(b64str) {
	var byteStr = atob(b64str)
	var bytes = new Uint8Array(byteStr.length)
	for (var i = 0; i < byteStr.length; i++) {
		bytes[i] = byteStr.charCodeAt(i)
	}
	return bytes.buffer
}
	
function convertPemToBinary(pem) {
	pem = pem.replace(/\r/g, '')
	var lines = pem.split('\n')
	var encoded = ''
	for(var i = 0;i < lines.length;i++){
		if (lines[i].trim().length > 0 &&
			lines[i].indexOf('-BEGIN PRIVATE KEY-') < 0 &&
			lines[i].indexOf('-BEGIN PUBLIC KEY-') < 0 &&
			lines[i].indexOf('-END PRIVATE KEY-') < 0 &&
			lines[i].indexOf('-END PUBLIC KEY-') < 0 &&
			lines[i].indexOf('-BEGIN RSA PRIVATE KEY-') < 0 &&
			lines[i].indexOf('-BEGIN RSA PUBLIC KEY-') < 0 &&
			lines[i].indexOf('-END RSA PRIVATE KEY-') < 0 &&
			lines[i].indexOf('-END RSA PUBLIC KEY-') < 0) {
				encoded += lines[i].trim()
		}
	}
	return base64StringToArrayBuffer(encoded)
}

function textToArrayBuffer(str) {
	var buf = unescape(encodeURIComponent(str)) // 2 bytes for each char
	var bufView = new Uint8Array(buf.length)
	for (var i=0; i < buf.length; i++) {
		bufView[i] = buf.charCodeAt(i)
	}
	return bufView
}

function arrayBufferToBase64String(arrayBuffer) {
	var byteArray = new Uint8Array(arrayBuffer)
	var byteString = ''
	for (var i=0; i<byteArray.byteLength; i++) {
		byteString += String.fromCharCode(byteArray[i])
	}
	return btoa(byteString)
}

async function sign(str, privateKeyPEM) {
	var signAlgorithm = {
		name: "RSASSA-PKCS1-v1_5",
		hash: {
			name: "SHA-256"
		}
	}
	const privateKey = await crypto.subtle.importKey("pkcs8", convertPemToBinary(privateKeyPEM), signAlgorithm, true, ["sign"])
	const buf = await window.crypto.subtle.sign(signAlgorithm, privateKey, textToArrayBuffer(str));
	return arrayBufferToBase64String(buf);
}

document.getElementById("button_app_status").addEventListener("click",
    function() {
		const xhr = new XMLHttpRequest();
		const url='http://127.0.0.1:14741';
		xhr.open("GET", url);
		xhr.onreadystatechange = function() {
		if (xhr.readyState === XMLHttpRequest.DONE) {
			console.log(xhr.responseText);
		}}
		xhr.send();
		},
		false
);

document.getElementById("button_login").addEventListener("click",
    function() {				
		const privateKeyPEM = document.getElementById("private_key_pem").value;
		const currentTime = Date.now() + "";
		sign(currentTime, privateKeyPEM).then(function(result) {
			const username = encodeURIComponent(document.getElementById("username").value);
			const partnerId = encodeURIComponent(document.getElementById("partner_id").value);
			const authorizationCode = encodeURIComponent(currentTime + ":" + result);
			//const authorizationCode = currentTime + ":" + result;
			
			const xhr = new XMLHttpRequest();
			const url='http://127.0.0.1:14741/login';
			const params = 'username=' + username + '&partnerId=' + partnerId + "&authorizationCode=" + authorizationCode;	
			xhr.open("POST", url);
			xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
			//xhr.setRequestHeader('X-Authorization-Code', authorizationCode);
			xhr.onreadystatechange = function() {
			if (xhr.readyState === XMLHttpRequest.DONE) {
				console.log(xhr.responseText);				
			}}
			xhr.send(params);
		});
	},
    false
);

document.getElementById("button_logout").addEventListener("click",
    function() {
		const xhr = new XMLHttpRequest();
		const url='http://127.0.0.1:14741/logout';
		xhr.open("POST", url);
		xhr.onreadystatechange = function() {
		if (xhr.readyState === XMLHttpRequest.DONE) {
			console.log(xhr.responseText);
		}}
		xhr.send();
		},
		false
);

document.getElementById("button_sign").addEventListener("click",
    function() {				
		const privateKeyPEM = document.getElementById("private_key_pem").value;
		const currentTime = Date.now() + "";
		sign(currentTime, privateKeyPEM).then(function(result) {
			const username = document.getElementById("username").value;
			const partnerId = document.getElementById("partner_id").value;
			const authorizationCode = currentTime + ":" + result;
			
			const formData = new FormData();
			const file = document.getElementById('file_input').files[0];			
			formData.append(file.name, file);
			formData.append("authorizationCode", authorizationCode);
			
			const xhr = new XMLHttpRequest();
			const url='http://127.0.0.1:14741/sign';
			xhr.open("POST", url);
			//xhr.setRequestHeader('X-Authorization-Code', authorizationCode);
			xhr.onreadystatechange = function() {
			if (xhr.readyState === XMLHttpRequest.DONE) {
				console.log(xhr.responseText);				
			}}
			xhr.send(formData);
		});
	},
    false
);
</script>

</body>
</html>