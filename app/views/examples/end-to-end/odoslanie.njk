{% extends "podanie-gov.njk" %}

{% block header %}
    {{ govukHeader({
        productName: 'slovensko.digital 2.0 - Podanie ako služba',
        homepageUrl: '/examples/podanie'
    }) }}
{% endblock %}

{% block main %}
    <h1>
      Odoslanie
    </h1>

    <style>
        .govuk-label {
            font-weight: bold;
        }
    </style>

    <div class="govuk-form-group" {% if user is null %}id="sender" style="display: none;"{% endif %}>
        <label class="govuk-label" for="subject">
            Odosielateľ:
        </label>
        {% if user is null %}
            <small style="color: gray; display: none;" id="podanie-settings-login-flow-before_auth">
                Zatiaľ neprihlásený. V ďalšom kroku, po kliknutí na tlačidlo "Odoslať", sa prihlásite na slovensko.sk
            </small>
            <small style="color: gray; display: none;" id="podanie-settings-login-flow-during_auth">
                Zatiaľ neprihlásený.
            </small>
        {% else %}
            {{ user.name }} <a href="/podanie/sign-out" class="govuk-link--muted">Odhlásiť</a>
        {% endif %}
    </div>

    <div class="govuk-form-group">
        <label class="govuk-label">
            Predmet:
        </label>
        {{ subject }}
    </div>

    <div class="govuk-form-group">
        <label class="govuk-label">
            Správa:
        </label>
        {{ message | escape | nl2br  }}
    </div>

{#    <strong>Prílohy</strong><br>#}
{#    <p id="message-file-placeholder"></p>#}

    <form>
      <button class="govuk-button">Odoslať</button>
    </form>
    <p id="flash-success" style="color: green"></p>
    <p id="flash-error" style="color: red"></p>
{% endblock %}

{% block js %}
    <script>
      function parseJwt(token) {
        var base64Url = token.split('.')[1];
        var base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        var jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
        }).join(''));

        return JSON.parse(jsonPayload);
      }

      function buildMessageObjectFromSignedFile(file) {
        return {
          name: file.name,
          description: file.name,
          encoding: 'Base64',
          mimeType: file.mimeType,
          isSigned: "true",
          content: file.content,
        }
      }

      $(document).ready(function(){
        var { message, subject, file } = JSON.parse(localStorage.getItem('podanie-form-data'));
        const signedFiles = [];//JSON.parse(localStorage.getItem('podanie-signed-data')).files;

        // $('#user-placeholder').html(parseJwt(oboToken).name)

        // $('#message-file-placeholder').html(`${file.name} (${file.mimeType})`)

        $('form').on('submit', function(event){
          $('form > button').prop('disabled', true).html('Odosielam...')

          $.ajax({
            url: '/podanie/send',
            type: 'post',
            data: {
              objects: {
                // form: buildMessageObjectFromSignedFile(signedFiles[0]),
                // attachments: signedFiles.slice(1).map(buildMessageObjectFromSignedFile),
              },
              messageSubject: subject,
            },
            success: function(data) {
              $('#flash-success').html(`Vaša správa bola úspešne odoslaná!`)
            },
            error: function(data) {
              $('#flash-error').html(`Pri odosielaní sa vyskytol problém: ${data.responseJSON ? data.responseJSON.message : data.statusText}`)
            },
            complete: function(data) {
              $('form > button').attr('disabled', false).html('Odoslať')
            }
          });

          return false;
        });
      });
    </script>
{% endblock %}
